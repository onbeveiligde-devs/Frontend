

<!--<iframe id="frame" width="100%" height="100%" frameBorder="0" [src]="src | safe"></iframe>-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache" />
  <title><%= title %></title>
  <script src="http://localhost:3000/crypto?1"></script>
</head>

<body>
<h2>GO WebM Live Streaming with Firefox: {{user.id}}</h2>
<button id="start_button" onclick="startVideo()">Start Video</button>
<button id="start_record_button" onclick="startRecording();">Start Live</button>
<button id="stop_record_button" onclick="stopRecording()">Stop Live</button>
<button id="stop_button" onclick="stopVideo()">Stop Video</button>

<!--
<button id="play_button" onclick="playRecorded()">Play</button>
<a href="#" id="downloadlink" class="download">Download</a>
-->

<br />
<video id="local_video" autoplay="1" style="max-width: 100%; border: 1px solid;"></video>
<!--
<video id="playback_video" width="320px" height="240px" autoplay="1" style="border: 1px solid;"></video>
-->
<div id="watch_link"></div>

<script>
  navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
  window.RTCPeerConnection = window.webkitRTCPeerConnection || window.mozRTCPeerConnection;
  window.RTCIceCandidate = window.mozRTCIceCandidate || window.RTCIceCandidate;

  var channelName = '{{user.id}}';
  var localVideo = document.getElementById('local_video');
  var watchDiv = document.getElementById('watch_link');
  var localStream = null;
  var recorder = null;
  var blobUrl = null;
  var blobUrls = [];
  var recordIndex = 0;
  var postIndex = 0;
  var postSec = 0;
  var intervalSec = 5;
  var intervalMiliSec = intervalSec * 1000;

  function startRecording() {
    if (!localStream) {
      console.error("no stream");
      return;
    }
    if (recorder) {
      console.warn("recorder already exist. reuse it.");
    }
    else {
      recorder = new MediaRecorder(localStream);
    }

    recorder.ondataavailable = function (evt) {
      var videoBlob = new Blob([evt.data], { type: evt.data.type });

      blobToBase64(videoBlob, async function (base64) {

        // --- post to server ---
        postSec = postIndex * intervalSec;
        var formData = new FormData();
        formData.append("blob_base64", base64);
        formData.append("blob_name", "video_" + postIndex + ".webm");
        formData.append("blob_index", postIndex);
        formData.append("blob_sec", postSec);

        let sign = await window.transCrypto.sign(base64 + "video_" + postIndex + ".webm" + postIndex + postSec, '{{privateKey}}');
        console.log('sign = ' + sign);

        formData.append("blob_sign", postSec);
        var xhr = new XMLHttpRequest();

        xhr.onreadystatechange = function () {
          if ((xhr.readyState == 4) && (xhr.status == 200)) {
            console.log("xhr finish. response= " + xhr.responseText);
          }
        }

        xhr.open("POST", "/upload/" + channelName, true);
        xhr.send(formData);

        if (postIndex == 1) {
          // post first block, then enable watch
          watchDiv.innerHTML = '<h1>You are now live!</h1>'
        }
        postIndex++;
      });
    }

    recorder.start(intervalMiliSec);
    console.log("start recording");
  }

  function stopRecording() {
    if (recorder) {
      recorder.stop();
      console.log("stop recording");
    }
  }

  function blobToBase64(blob, callback) {
    var reader = new FileReader();
    reader.onload = function () {
      var dataUrl = reader.result;
      var base64 = dataUrl.split(',')[2];

      if (base64 == null) {
        base64 = dataUrl.split(',')[1];
      }

      callback(base64);
    };
    reader.readAsDataURL(blob);
  }

  // Request the usermedia
  function startVideo() {

    navigator.mediaDevices.getUserMedia({
      video:
        {
          optional: [
            { minWidth: 320 },
            { minWidth: 640 },
            { minWidth: 1024 },
            { minWidth: 1280 },
            { minWidth: 1920 },
            { minWidth: 2560 },
          ]
        },
      audio: true
    }).then((stream) => {
      localStream = stream;
      localVideo.srcObject = stream;
      localVideo.volume = 0;
    });
  }

  function stopVideo() {
    if (localStream) {
      localVideo.pause();
      localVideo.srcDoc = "";

      localStream.stop();
      localStream = null;
    }
  }

</script>
</body>
